<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Pixel Art Studio Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #0f0f0f; font-family: 'Inter', sans-serif; color: #fff; }
        #viewport { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
        canvas { 
            background: white; 
            image-rendering: pixelated; 
            position: absolute;
            transform-origin: 0 0;
            box-shadow: 0 0 80px rgba(0,0,0,0.9);
        }
        .ui { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100;
            background: rgba(30, 30, 30, 0.95); padding: 10px 25px;
            border-radius: 50px; display: flex; gap: 20px; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #444;
        }
        .tool-group { display: flex; gap: 8px; align-items: center; }
        button { 
            padding: 8px 15px; cursor: pointer; border: none; border-radius: 20px; 
            background: #333; color: white; transition: 0.2s; font-size: 13px;
        }
        button:hover { background: #444; }
        button.active { background: #007bff; box-shadow: 0 0 10px rgba(0,123,255,0.5); }
        input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; background: none; }
        
        input[type="range"] {
            -webkit-appearance: none; width: 100px; height: 4px; background: #555; border-radius: 5px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px; background: #007bff; border-radius: 50%; cursor: pointer; transition: 0.2s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        .other-cursor { position: absolute; pointer-events: none; z-index: 50; font-size: 10px; text-shadow: 1px 1px 1px #000; }
        .dot { width: 4px; height: 4px; background: #ff4757; border-radius: 50%; }
        #footer { position: fixed; bottom: 15px; width: 100%; text-align: center; font-size: 11px; color: #666; pointer-events: none; }
    </style>
</head>
<body>

<div class="ui">
    <div class="tool-group">
        <button id="penBtn" class="active" onclick="setTool('pen')">Ołówek</button>
        <button id="eraBtn" onclick="setTool('eraser')">Gumka</button>
        <button id="fillBtn" onclick="setTool('fill')">Wiadro</button>
    </div>
    <div class="tool-group">
        <input type="color" id="colorPicker" value="#000000">
    </div>
    <div class="tool-group">
        <label style="font-size:12px">Rozmiar:</label>
        <input type="range" id="sizePicker" min="1" max="25" value="1">
        <span id="sizeVal" style="width:30px">1px</span>
    </div>
    <div class="tool-group">
        <input type="checkbox" id="smoothCheck">
        <label style="font-size:12px">Smoothing</label>
    </div>
</div>

<div id="footer">LPM: Rysuj | PPM: Kamera | SHIFT: Snap 45° | Rolka: Zoom</div>

<div id="viewport">
    <canvas id="canvas" width="2048" height="1024"></canvas>
    <div id="cursors"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCwk4Im8EtC_Eyu7dllwqTW54dwOXPhhf4",
        authDomain: "freedraw-ef17b.firebaseapp.com",
        databaseURL: "https://freedraw-ef17b-default-rtdb.firebaseio.com/",
        projectId: "freedraw-ef17b",
        storageBucket: "freedraw-ef17b.firebasestorage.app",
        messagingSenderId: "155298386414",
        appId: "1:155298386414:web:f2a57cb5556a8e05c13eff"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const viewport = document.getElementById('viewport');
    const cursorsLayer = document.getElementById('cursors');
    const sizePicker = document.getElementById('sizePicker');
    const sizeVal = document.getElementById('sizeVal');
    const smoothCheck = document.getElementById('smoothCheck');
    
    let scale = 0.5;
    let camX = (window.innerWidth - 2048 * scale) / 2;
    let camY = (window.innerHeight - 1024 * scale) / 2;
    let isDrawing = false, isPanning = false;
    let currentTool = 'pen';
    let startX = 0, startY = 0;

    const userName = prompt("Twój Nick:") || "User" + Math.floor(Math.random()*100);
    const userId = Math.random().toString(36).substring(7);

    const userRef = db.ref('users/' + userId);
    userRef.onDisconnect().remove();

    function updateTransform() {
        canvas.style.transform = `translate(${camX}px, ${camY}px) scale(${scale})`;
    }

    function setTool(t) {
        currentTool = t;
        document.querySelectorAll('.tool-group button').forEach(b => b.classList.remove('active'));
        if(t === 'pen') {
            document.getElementById('penBtn').classList.add('active');
            sizePicker.max = 25;
        } else if(t === 'eraser') {
            document.getElementById('eraBtn').classList.add('active');
            sizePicker.max = 50;
        } else {
            document.getElementById('fillBtn').classList.add('active');
        }
    }

    sizePicker.oninput = () => sizeVal.innerText = sizePicker.value + 'px';

    function getCoords(e) {
        return {
            x: Math.floor((e.clientX - camX) / scale),
            y: Math.floor((e.clientY - camY) / scale)
        };
    }

    viewport.oncontextmenu = (e) => e.preventDefault();

    viewport.onmousedown = (e) => {
        if (e.button === 0) {
            if (currentTool === 'fill') {
                floodFill(getCoords(e));
            } else {
                isDrawing = true;
                const pos = getCoords(e);
                startX = pos.x; startY = pos.y;
                draw(e);
            }
        } else if (e.button === 2) isPanning = true;
    };

    window.onmousemove = (e) => {
        if (isDrawing) draw(e);
        if (isPanning) {
            camX += e.movementX;
            camY += e.movementY;
            updateTransform();
        }
        userRef.set({ x: e.clientX, y: e.clientY, name: userName });
    };

    window.onmouseup = () => { isDrawing = false; isPanning = false; };

    function draw(e) {
        let pos = getCoords(e);
        if (e.shiftKey) {
            const dx = pos.x - startX, dy = pos.y - startY;
            const angle = Math.round(Math.atan2(dy, dx) / (Math.PI / 4)) * (Math.PI / 4);
            const dist = Math.sqrt(dx*dx + dy*dy);
            pos.x = Math.round(startX + Math.cos(angle) * dist);
            pos.y = Math.round(startY + Math.sin(angle) * dist);
        }

        const color = currentTool === 'eraser' ? '#FFFFFF' : document.getElementById('colorPicker').value;
        const size = parseInt(sizePicker.value);
        const smooth = smoothCheck.checked;

        if (!smooth) {
            for (let i = -Math.floor(size/2); i < Math.ceil(size/2); i++) {
                for (let j = -Math.floor(size/2); j < Math.ceil(size/2); j++) {
                    db.ref('pixels/' + (pos.x + i) + '_' + (pos.y + j)).set(color);
                }
            }
        } else {
            drawSoft(pos.x, pos.y, size, color);
        }
    }

    function drawSoft(cx, cy, radius, color) {
        for (let x = -radius; x <= radius; x++) {
            for (let y = -radius; y <= radius; y++) {
                const dist = Math.sqrt(x*x + y*y);
                if (dist <= radius) {
                    if (Math.random() > (dist / radius)) {
                        db.ref('pixels/' + (cx + x) + '_' + (cy + y)).set(color);
                    }
                }
            }
        }
    }

    

    function floodFill(pos) {
        const targetColor = ctx.getImageData(pos.x, pos.y, 1, 1).data;
        const fillColor = document.getElementById('colorPicker').value;
        db.ref('pixels/' + pos.x + '_' + pos.y).set(fillColor);
    }

    viewport.onwheel = (e) => {
        e.preventDefault();
        const factor = e.deltaY > 0 ? 0.9 : 1.1;
        scale *= factor;
        scale = Math.min(Math.max(0.1, scale), 20);
        updateTransform();
    };

    db.ref('pixels').on('child_added', (s) => {
        const [x, y] = s.key.split('_');
        ctx.fillStyle = s.val();
        ctx.fillRect(x, y, 1, 1);
    });

    db.ref('pixels').on('child_changed', (s) => {
        const [x, y] = s.key.split('_');
        ctx.fillStyle = s.val();
        ctx.fillRect(x, y, 1, 1);
    });

    db.ref('users').on('value', (s) => {
        cursorsLayer.innerHTML = '';
        const data = s.val();
        for (let id in data) {
            if (id === userId) continue;
            const u = data[id];
            const div = document.createElement('div');
            div.className = 'other-cursor';
            div.style.left = u.x + 'px';
            div.style.top = u.y + 'px';
            div.innerHTML = `<div class="dot"></div>${u.name}`;
            cursorsLayer.appendChild(div);
        }
    });

    updateTransform();
</script>

</body>
</html>
