<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Multiplayer Canvas Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; }
        #viewport { width: 100vw; height: 100vh; overflow: hidden; position: relative; cursor: crosshair; }
        canvas { 
            background: white; 
            image-rendering: pixelated; 
            transform-origin: 0 0;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .ui-panel { 
            position: fixed; 
            top: 20px; 
            left: 20px; 
            background: rgba(255, 255, 255, 0.9); 
            padding: 15px; 
            border-radius: 12px; 
            z-index: 100; 
            display: flex; 
            gap: 10px; 
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .tool-btn { 
            padding: 8px 12px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            cursor: pointer; 
            background: white;
        }
        .tool-btn.active { background: #007bff; color: white; border-color: #0056b3; }
        .other-cursor {
            position: absolute;
            pointer-events: none;
            font-size: 10px;
            color: white;
            text-shadow: 1px 1px 1px black;
            z-index: 50;
        }
        .cursor-dot { width: 4px; height: 4px; background: red; border-radius: 50%; }
        #zoom-info { position: fixed; bottom: 20px; right: 20px; color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="ui-panel">
    <button class="tool-btn active" id="penTool" onclick="setTool('pen')">Ołówek</button>
    <button class="tool-btn" id="eraserTool" onclick="setTool('eraser')">Gumka</button>
    <input type="color" id="colorPicker" value="#000000">
    <div style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></div>
    <span id="nickDisplay" style="font-weight: bold;"></span>
</div>

<div id="zoom-info">Zoom: 100%</div>

<div id="viewport">
    <canvas id="canvas" width="2048" height="1024"></canvas>
    <div id="remoteCursors"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCwk4Im8EtC_Eyu7dllwqTW54dwOXPhhf4",
        authDomain: "freedraw-ef17b.firebaseapp.com",
        databaseURL: "https://freedraw-ef17b-default-rtdb.firebaseio.com",
        projectId: "freedraw-ef17b",
        storageBucket: "freedraw-ef17b.firebasestorage.app",
        messagingSenderId: "155298386414",
        appId: "1:155298386414:web:f2a57cb5556a8e05c13eff"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const viewport = document.getElementById('viewport');
    const colorPicker = document.getElementById('colorPicker');
    const remoteCursors = document.getElementById('remoteCursors');
    const zoomInfo = document.getElementById('zoom-info');

    let currentTool = 'pen';
    let scale = 1;
    let offsetX = 0;
    let offsetY = 0;
    let isDrawing = false;

    const userName = prompt("Podaj swój nick:") || "User" + Math.floor(Math.random() * 100);
    const userId = Math.random().toString(36).substring(7);
    document.getElementById('nickDisplay').innerText = userName;

    const userRef = db.ref('users/' + userId);
    userRef.onDisconnect().remove();

    function setTool(tool) {
        currentTool = tool;
        document.getElementById('penTool').classList.toggle('active', tool === 'pen');
        document.getElementById('eraserTool').classList.toggle('active', tool === 'eraser');
    }

    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: Math.floor((e.clientX - rect.left) / scale),
            y: Math.floor((e.clientY - rect.top) / scale)
        };
    }

    function paint(e) {
        if (!isDrawing) return;
        const pos = getMousePos(e);
        const color = currentTool === 'eraser' ? '#FFFFFF' : colorPicker.value;
        db.ref('pixels/' + pos.x + '_' + pos.y).set(color);
    }

    viewport.addEventListener('mousedown', (e) => {
        isDrawing = true;
        paint(e);
    });

    window.addEventListener('mouseup', () => isDrawing = false);
    viewport.addEventListener('mousemove', (e) => {
        paint(e);
        userRef.set({
            x: e.clientX,
            y: e.clientY,
            name: userName
        });
    });

    viewport.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        scale *= delta;
        scale = Math.min(Math.max(0.1, scale), 20);
        canvas.style.transform = `scale(${scale})`;
        zoomInfo.innerText = `Zoom: ${Math.round(scale * 100)}%`;
    }, { passive: false });

    db.ref('pixels').on('child_added', (snap) => {
        const [x, y] = snap.key.split('_');
        ctx.fillStyle = snap.val();
        ctx.fillRect(x, y, 1, 1);
    });

    db.ref('pixels').on('child_changed', (snap) => {
        const [x, y] = snap.key.split('_');
        ctx.fillStyle = snap.val();
        ctx.fillRect(x, y, 1, 1);
    });

    db.ref('users').on('value', (snap) => {
        remoteCursors.innerHTML = '';
        const users = snap.val();
        for (let id in users) {
            if (id === userId) continue;
            const u = users[id];
            const div = document.createElement('div');
            div.className = 'other-cursor';
            div.style.left = u.x + 'px';
            div.style.top = u.y + 'px';
            div.innerHTML = `<div class="cursor-dot"></div> ${u.name}`;
            remoteCursors.appendChild(div);
        }
    });
</script>

</body>
</html>
